"""Core trajectory data models."""

from dataclasses import dataclass, field
from typing import Any


@dataclass
class ToolCall:
    """Represents a single tool call within a trajectory step.
    
    This is a pure data container. All parsing/extraction logic
    should be handled by the format-specific loaders.
    """
    
    name: str
    """Tool name, e.g., 'shell', 'str_replace_editor', 'search'."""
    
    arguments: dict[str, Any] = field(default_factory=dict)
    """Tool-specific parameters."""
    
    result: str | None = None
    """Tool output/observation."""
    
    success: bool = True
    """Whether tool executed successfully."""
    
    shell_command: str | None = None
    """Base shell command if this is a shell tool call (e.g., 'grep', 'cat').
    
    Should be set by the loader when parsing shell/bash tool calls.
    """


@dataclass
class Step:
    """Represents a single step in an agent trajectory."""
    
    index: int
    """Step index within the trajectory."""
    
    thought: str | None = None
    """Reasoning/thinking content before tool call."""
    
    tool_calls: list[ToolCall] = field(default_factory=list)
    """Tool calls made in this step."""
    
    token_usage: int = 0
    """Tokens used in this step."""
    
    @property
    def num_tool_calls(self) -> int:
        """Number of tool calls in this step."""
        return len(self.tool_calls)
    
    @property
    def successful_tool_calls(self) -> int:
        """Number of successful tool calls."""
        return sum(1 for tc in self.tool_calls if tc.success)


@dataclass
class Trajectory:
    """Represents a complete agent trajectory for solving one instance."""
    
    instance_id: str
    """SWE-bench instance ID (e.g., 'astropy__astropy-14096')."""
    
    steps: list[Step] = field(default_factory=list)
    """Sequence of steps in the trajectory."""
    
    generated_patch: str | None = None
    """The diff/patch generated by the agent."""
    
    resolved: bool | None = None
    """Whether the instance was resolved (from SWE-bench results). None if unknown."""
    
    exit_reason: str | None = None
    """Why the trajectory ended (e.g., 'agent', 'max_steps', 'error')."""
    
    @property
    def total_tokens(self) -> int:
        """Total tokens used across all steps."""
        return sum(step.token_usage for step in self.steps)
    
    @property
    def total_tool_calls(self) -> int:
        """Total tool calls across all steps."""
        return sum(step.num_tool_calls for step in self.steps)
    
    @property
    def has_patch(self) -> bool:
        """Whether the agent generated a non-empty patch."""
        return bool(self.generated_patch and self.generated_patch.strip())
    
    @property
    def num_steps(self) -> int:
        """Number of steps in the trajectory."""
        return len(self.steps)
    
    def get_tool_calls(self) -> list[ToolCall]:
        """Get all tool calls across all steps."""
        return [tc for step in self.steps for tc in step.tool_calls]
    
    def get_tool_counts(self) -> dict[str, int]:
        """Count tool calls by tool name."""
        counts: dict[str, int] = {}
        for tc in self.get_tool_calls():
            counts[tc.name] = counts.get(tc.name, 0) + 1
        return counts
    
    def get_shell_command_counts(self) -> dict[str, int]:
        """Count shell commands by base command."""
        counts: dict[str, int] = {}
        for tc in self.get_tool_calls():
            if tc.shell_command:
                counts[tc.shell_command] = counts.get(tc.shell_command, 0) + 1
        return counts
    
    def get_tool_success_rate(self, tool_name: str | None = None) -> float:
        """Get success rate for tool calls, optionally filtered by tool name."""
        tool_calls = self.get_tool_calls()
        if tool_name:
            tool_calls = [tc for tc in tool_calls if tc.name == tool_name]
        
        if not tool_calls:
            return 0.0
        
        return sum(1 for tc in tool_calls if tc.success) / len(tool_calls)

